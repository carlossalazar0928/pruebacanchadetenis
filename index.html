<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reserva de Tenis - Club Asturiano</title>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" type="module"></script>

<style>
/* ==================== CONFIGURACI√ìN VISUAL ==================== */
:root {
  --primary: #235d3a; /* Verde Club */
  --accent: #d2e603;  /* Amarillo Pelota */
  --white: #ffffff;
  --logo-url: url('https://i.ibb.co/fzKg4fGZ/logo-2.jpg'); 
}

body {
  margin: 0;
  padding: 0;
  font-family: 'Lato', sans-serif;
  background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), 
              url('https://i.ibb.co/qFWNMRJw/20241127095946-pelota.jpg') center/cover no-repeat fixed;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* ==================== TARJETA PRINCIPAL ==================== */
.container {
  background: var(--white);
  width: 90%;
  max-width: 420px;
  padding: 70px 30px 35px 30px;
  border-radius: 15px;
  box-shadow: 0 25px 50px rgba(0,0,0,0.5);
  position: relative;
  box-sizing: border-box;
}

/* LOGO CIRCULAR FLOTANTE */
.container::before {
  content: '';
  position: absolute;
  top: -55px;
  left: 50%;
  transform: translateX(-50%);
  width: 110px;
  height: 110px;
  background: var(--white) var(--logo-url) center/cover no-repeat;
  border-radius: 50%;
  box-shadow: 0 10px 20px rgba(0,0,0,0.3);
  border: 5px solid var(--white);
  z-index: 10;
}

/* ELEMENTOS DE TEXTO */
h1, h2 { color: var(--primary); text-align: center; margin-top: 10px; font-weight: 900; font-size: 1.4rem; }
p { color: #555; text-align: center; font-size: 0.9rem; margin-bottom: 20px; }
label { display: block; font-weight: 700; font-size: 0.8rem; color: var(--primary); text-transform: uppercase; margin-top: 15px; margin-bottom: 5px; }

input, select {
  width: 100%;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background: #f9f9f9;
  font-size: 1rem;
  box-sizing: border-box;
  transition: 0.3s;
}

input:focus { outline: none; border-color: var(--primary); background: #fff; }

/* BOT√ìN PRINCIPAL */
button {
  width: 100%;
  padding: 15px;
  margin-top: 25px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 700;
  text-transform: uppercase;
  cursor: pointer;
  letter-spacing: 1px;
  transition: 0.3s;
}

button:hover { background: #1a452b; transform: translateY(-2px); }

/* CARGADOR (PANTALLA COMPLETA) */
#loading {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(255, 255, 255, 0.95);
  z-index: 10000;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.hidden { display: none !important; }

/* TABLAS */
table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.85rem; }
th { background: var(--primary); color: white; padding: 10px; }
td { border-bottom: 1px solid #eee; padding: 10px; color: #333; }
.status-pagado { color: green; font-weight: bold; }
.status-pendiente { color: #e67e22; font-weight: bold; }

  #loading {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(5px); /* Desenfoque de fondo */
  z-index: 99999; /* Por encima de todo */
  display: flex;
  justify-content: center;
  align-items: center;
}

.loader-content {
  text-align: center;
}

.loader-content img {
  width: 120px; /* Tama√±o de la pelota */
  height: auto;
  margin-bottom: 15px;
}

.loader-content p {
  color: #235d3a;
  font-weight: 900;
  letter-spacing: 2px;
  font-family: 'Lato', sans-serif;
  margin: 0;
}

.hidden { display: none !important; }
</style>
</head>

<body>

<div id="loading" class="hidden">
  <div class="loader-content">
    <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExc3R0czg1ZjZnc2R3Y2h5ZmEzNjRkYjdpYWpxN3hzODlubHk0dDF2cyZlcD12MV9naWZzX3NlYXJjaCZjdD1n/fUqFdyJeDB9YMzaZ0P/giphy.gif" alt="Cargando...">
    <p>PROCESANDO...</p>
  </div>
</div>

<div class="container">
  <div id="view-login">
    <h1>Club Asturiano</h1>
    <p>Reserva de Canchas de Tenis</p>
    
    <label>N√∫mero de Socio</label>
    <input type="number" id="login-socio" placeholder="Ej: 1234">
    
    <label>Fecha de Nacimiento</label>
    <input type="text" id="login-fecha" placeholder="DD/MM/AAAA" maxlength="10">
    <small style="color:#888;">Formato autom√°tico al escribir.</small>
    
    <button onclick="validarUsuario()">Ingresar al Sistema</button>
    
    <div style="text-align:center; margin-top:20px;">
        <a href="#" onclick="showAdminLogin()" style="color:#999; text-decoration:none; font-size:0.8rem;">Acceso Administrador</a>
    </div>
  </div>

  <div id="view-booking" class="hidden">
    <h2 id="welcome-msg">Hola Socio</h2>
    
    <label>Fecha de Reserva</label>
    <input type="date" id="reserva-fecha" onchange="cargarConfiguracionDia()">
    
    <div id="config-area" class="hidden">
      <div style="display:flex; gap:10px;">
        <div style="flex:1;">
           <label>Hora Inicio</label>
           <select id="reserva-hora" onchange="calcularPrecio()"></select>
        </div>
        <div style="flex:1;">
           <label>Duraci√≥n</label>
           <select id="reserva-duracion" onchange="cargarCanchas(); calcularPrecio();">
             <option value="1">1 Hora</option>
             <option value="2">2 Horas</option>
           </select>
        </div>
      </div>

      <label>Tipo de Juego</label>
      <select id="reserva-tipo" onchange="generarCamposJugadores(); calcularPrecio();">
        <option value="single">Single (2 Personas)</option>
        <option value="doble">Dobles (4 Personas)</option>
      </select>
      
      <label>Seleccionar Cancha</label>
      <select id="reserva-cancha">
        <option value="">-- Seleccione horario --</option>
      </select>

      <div id="jugadores-container" style="margin-top:15px; border:1px solid #eee; padding:10px; border-radius:8px;"></div>

      <div id="precio-total" style="background:var(--accent); color:var(--primary); padding:10px; text-align:center; font-weight:900; margin-top:15px; border-radius:8px;">
        Total a Pagar: $0
      </div>

      <button onclick="enviarReserva()">Confirmar Reserva</button>
    </div>
  </div>

  <div id="view-success" class="hidden">
    <h2 style="color:green;">¬°Reserva Exitosa!</h2>
    <div id="resumen-final" style="background:#f0f9f0; padding:15px; border-radius:8px; border:1px solid green; font-size:0.9rem;"></div>
    <button onclick="location.reload()">Hacer otra reserva</button>
  </div>

  <div id="view-admin" class="hidden">
    <h2>Panel Control</h2>
    <div id="admin-content" style="overflow-x:auto;">
      <table id="admin-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Cancha</th>
            <th>Titular</th>
            <th>Estado</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <button onclick="location.reload()" style="background:#666;">Cerrar Panel</button>
  </div>
</div>

<script>
  // --- M√ÅSCARA AUTOM√ÅTICA DE FECHA ---
  const inputFecha = document.getElementById('login-fecha');
  inputFecha.addEventListener('keyup', function(e) {
    if (e.key !== 'Backspace') {
      let v = this.value;
      if (v.match(/^\d{2}$/) !== null) this.value = v + '/';
      else if (v.match(/^\d{2}\/\d{2}$/) !== null) this.value = v + '/';
    }
  });

  const API_URL = "https://script.google.com/macros/s/AKfycbxaAz1Z1PKwIyiyDV_WCT1qhHC_ALdsgpqH0U0Xf1oeWFHYHISjK5unJtyCtSYISMu7/exec"; 

async function llamarAPI(accion, datos = {}) {
  const loader = document.getElementById('loading');
  
  // 1. Mostrar la pelota antes de la petici√≥n
  loader.classList.remove('hidden');

  try {
    const response = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ action: accion, ...datos })
    });
    const resultado = await response.json();
    
    // 2. Ocultar la pelota cuando llega la respuesta
    loader.classList.add('hidden');
    return resultado;
  } catch (error) {
    // 3. Ocultar si hay error para no bloquear la pantalla
    loader.classList.add('hidden');
    console.error("Error:", error);
    return null;
  }
}

  let usuarioActual = "";

  async function validarUsuario() {
    const socio = document.getElementById('login-socio').value;
    const fecha = document.getElementById('login-fecha').value;
    if(!socio || !fecha) return alert("Complete los datos");

    const res = await llamarAPI('validarSocio', { socio, fecha });
    if (res && res.success) {
        usuarioActual = { id: socio, nombre: res.nombre };
        document.getElementById('view-login').classList.add('hidden');
        document.getElementById('view-booking').classList.remove('hidden');
        document.getElementById('welcome-msg').innerText = "Hola, " + res.nombre;
        inicializarHoras();
    } else {
        alert("Socio no encontrado o fecha incorrecta.");
    }
  }

  function inicializarHoras() {
    const select = document.getElementById('reserva-hora');
    select.innerHTML = "";
    for(let i=7; i<=20; i++) {
       let opt = document.createElement('option');
       opt.value = i; opt.text = i + ":00 hs";
       select.appendChild(opt);
    }
    generarCamposJugadores();
  }

  function cargarConfiguracionDia() {
    const fecha = document.getElementById('reserva-fecha').value;
    if(!fecha) return;
    const dia = new Date(fecha + 'T00:00:00').getDay();
    if(dia === 1) {
      alert("Lunes cerrado");
      document.getElementById('reserva-fecha').value = "";
      return;
    }
    document.getElementById('config-area').classList.remove('hidden');
    cargarCanchas();
  }

  async function cargarCanchas() {
    const fecha = document.getElementById('reserva-fecha').value;
    const hora = document.getElementById('reserva-hora').value;
    const duracion = document.getElementById('reserva-duracion').value;
    
    const ocupadas = await llamarAPI('obtenerDisponibilidad', { fechaStr: fecha });
    const select = document.getElementById('reserva-cancha');
    select.innerHTML = "";
    
    const dia = new Date(fecha + 'T00:00:00').getDay();
    let limite = (dia === 0 || dia === 6) ? 6 : 2;

    for(let i=1; i<=limite; i++) {
      let ocupada = ocupadas?.some(r => r.cancha == i && Math.max(r.hora, hora) < Math.min(parseInt(r.hora)+parseInt(r.duracion), parseInt(hora)+parseInt(duracion)));
      if(!ocupada) {
        let opt = document.createElement('option');
        opt.value = i; opt.text = "Cancha " + i;
        select.appendChild(opt);
      }
    }
    if(select.options.length === 0) select.innerHTML = "<option>No hay canchas</option>";
  }

  function generarCamposJugadores() {
    const tipo = document.getElementById('reserva-tipo').value;
    const container = document.getElementById('jugadores-container');
    container.innerHTML = "<p><b>Jugadores:</b></p>";
    let cantidad = (tipo === 'single') ? 2 : 4;
    for(let i=2; i<=cantidad; i++) {
      container.innerHTML += `
        <div style="display:flex; gap:5px; margin-bottom:5px;">
          <select class="tipo-jugador" onchange="calcularPrecio()" style="width:40%"><option value="socio">Socio</option><option value="nosocio">No Socio</option></select>
          <input type="text" class="dato-jugador" placeholder="Nombre/Socio" style="width:60%">
        </div>`;
    }
  }

  function calcularPrecio() {
    const hora = parseInt(document.getElementById('reserva-hora').value);
    const duracion = parseInt(document.getElementById('reserva-duracion').value);
    let tSocio = (hora < 18) ? 1000 : 1500;
    let tNoSocio = (hora < 18) ? 2000 : 2500;
    
    let total = tSocio * duracion; // Titular
    const otros = document.querySelectorAll('.tipo-jugador');
    otros.forEach(s => total += (s.value === 'socio' ? tSocio : tNoSocio) * duracion);
    
    document.getElementById('precio-total').innerText = "Total a Pagar: $" + total;
    return total;
  }

 async function enviarReserva() {
    const cancha = document.getElementById('reserva-cancha').value;
    if(!cancha || isNaN(cancha)) return alert("Seleccione una cancha v√°lida.");

    // Capturar datos b√°sicos
    const fecha = document.getElementById('reserva-fecha').value;
    const hora = document.getElementById('reserva-hora').value;
    const duracion = document.getElementById('reserva-duracion').value;
    const total = calcularPrecio();

    // RECOPILAR JUGADORES (Titular + Invitados)
    let detalleJugadores = `${usuarioActual.nombre} (Titular)`;
    const inputsJugadores = document.getElementsByClassName('dato-jugador');
    for(let inp of inputsJugadores) {
      if(inp.value.trim() !== "") {
        detalleJugadores += `, ${inp.value.trim()}`;
      }
    }

    const datos = {
      fecha: fecha,
      hora: hora,
      duracion: duracion,
      cancha: cancha,
      socioTitular: usuarioActual.id,
      detalleJugadores: detalleJugadores,
      total: total
    };

    const res = await llamarAPI('guardarReserva', { datos });
    
    if(res?.success) {
      document.getElementById('view-booking').classList.add('hidden');
      document.getElementById('view-success').classList.remove('hidden');
      
      // CONFIGURACI√ìN DEL MENSAJE Y N√öMERO
      const nroCasilla = "5491130351121";
      const mensajeWA = `üéæ *RESERVA DE TENIS*%0A` +
                        `*CLUB ASTURIANO*%0A%0A` +
                        `üë§ *Titular:* ${usuarioActual.nombre}%0A` +
                        `üìÖ *Fecha:* ${fecha}%0A` +
                        `‚è∞ *Hora:* ${hora}:00 hs (${duracion}h)%0A` +
                        `üèüÔ∏è *Cancha:* ${cancha}%0A` +
                        `üë• *Jugadores:* ${detalleJugadores}%0A` +
                        `üí∞ *Total a Pagar:* $${total}%0A%0A` +
                        `_Enviado desde el Sistema de Reservas._`;

      // Generar URL directa al chat de la casilla
      const urlWA = `https://wa.me/${nroCasilla}?text=${mensajeWA}`;

      document.getElementById('resumen-final').innerHTML = `
        <div style="text-align:left; font-size:0.9rem;">
          <p><strong>Titular:</strong> ${usuarioActual.nombre}</p>
          <p><strong>Fecha:</strong> ${fecha}</p>
          <p><strong>Cancha:</strong> ${cancha} (${hora}:00 hs)</p>
          <p style="font-size:1.1rem; color:var(--primary);"><strong>Total: $${total}</strong></p>
        </div>
        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
        <p style="font-size:0.85rem; color:#444; margin-bottom:12px;">
          Para completar el proceso, env√≠e el comprobante a la casilla del club:
        </p>
        <a href="${urlWA}" target="_blank" style="display:block; background:#25d366; color:white; text-decoration:none; padding:15px; border-radius:8px; font-weight:bold; text-align:center; box-shadow: 0 4px 12px rgba(37,211,102,0.4); text-transform:uppercase; letter-spacing:1px;">
          üì≤ Enviar a la Casilla
        </a>
      `;
    } else {
      alert("Error al guardar reserva. Intente nuevamente.");
    }
  }
</script>
</body>
</html>
