<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reserva de Tenis - Club Asturiano</title>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">

<style>
/* ==================== CONFIGURACI√ìN VISUAL ==================== */
:root {
  --primary: #235d3a;
  --accent: #d2e603;
  --white: #ffffff;
  --logo-url: url('https://i.ibb.co/fzKg4fGZ/logo-2.jpg'); 
}

body {
  margin: 0; padding: 0;
  font-family: 'Lato', sans-serif;
  background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), 
              url('https://i.ibb.co/qFWNMRJw/20241127095946-pelota.jpg') center/cover no-repeat fixed;
  min-height: 100vh;
  display: flex; justify-content: center; align-items: center;
}

.container {
  background: var(--white);
  width: 95%; 
  max-width: 450px;
  padding: 70px 25px 35px 25px;
  border-radius: 15px;
  box-shadow: 0 25px 50px rgba(0,0,0,0.5);
  position: relative;
  box-sizing: border-box;
  transition: all 0.4s ease;
}

.container::before {
  content: '';
  position: absolute; top: -55px; left: 50%;
  transform: translateX(-50%);
  width: 110px; height: 110px;
  background: var(--white) var(--logo-url) center/cover no-repeat;
  border-radius: 50%;
  box-shadow: 0 10px 20px rgba(0,0,0,0.3);
  border: 5px solid var(--white);
  z-index: 10;
}

h1, h2, h3 { color: var(--primary); text-align: center; margin-top: 10px; font-weight: 900; }
h1 { font-size: 1.4rem; }
h2 { font-size: 1.2rem; }
p { color: #555; text-align: center; font-size: 0.9rem; margin-bottom: 20px; }
label { display: block; font-weight: 700; font-size: 0.75rem; color: var(--primary); text-transform: uppercase; margin-top: 12px; margin-bottom: 4px; }

input, select, textarea {
  width: 100%; padding: 10px;
  border: 1px solid #ddd; border-radius: 8px;
  background: #f9f9f9; font-size: 0.9rem;
  box-sizing: border-box; transition: 0.3s;
}

button {
  width: 100%; padding: 15px; margin-top: 20px;
  background: var(--primary); color: white;
  border: none; border-radius: 8px;
  font-weight: 700; text-transform: uppercase;
  cursor: pointer; letter-spacing: 1px; transition: 0.3s;
}

button:hover { background: #1a452b; transform: translateY(-2px); }

.hidden { display: none !important; }

/* ADMIN UI */
.container.admin-mode { max-width: 900px !important; }

.status-badge {
  padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase;
}
.status-pagado { background: #d4edda; color: #155724; }
.status-pendiente { background: #fff3cd; color: #856404; }
.status-noshow { background: #f8d7da; color: #721c24; }

table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.8rem; }
th { background: var(--primary); color: white; padding: 10px; text-align: left; }
td { border-bottom: 1px solid #eee; padding: 8px; }

#loading {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(5px);
  z-index: 99999; display: flex; justify-content: center; align-items: center;
}
</style>
</head>

<body>

<div id="loading" class="hidden">
  <div style="text-align:center;">
    <img src="https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3enpiZ2Z2Nzl6cHdmNWgxOHI0d3F5c2xwcDloaTgzbDVneDFubGZldiZlcD12MV9naWZzX3JlbGF0ZWQmY3Q9Zw/WouU7wwav5MqzzmmtQ/giphy.gif" width="100">
    <p style="color: var(--primary); font-weight: 900;">PROCESANDO...</p>
  </div>
</div>

<div class="container">
  <div id="view-login">
    <h1>Club Asturiano</h1>
    <p>Reserva de Canchas de Tenis</p>
    <label>N√∫mero de Socio</label>
    <input type="number" id="login-socio" placeholder="Ej: 1234">
    <label>Fecha de Nacimiento</label>
    <input type="text" id="login-fecha" placeholder="DD/MM/AAAA" maxlength="10">
    <button onclick="validarUsuario()">Ingresar</button>
    <button onclick="showAdminLogin()" style="background:none; color:#999; font-size:0.7rem; margin-top:10px;">üîí Administraci√≥n</button>
  </div>

  <div id="view-booking" class="hidden">
    <h2 id="welcome-msg">Hola Socio</h2>
    <label>Fecha</label>
    <input type="date" id="reserva-fecha" onchange="validarLunes(this); actualizarInterfaz();" onkeydown="return false">
    
    <div id="config-area" class="hidden">
      <label>Horario de Inicio</label>
      <select id="reserva-hora" onchange="actualizarInterfaz()"></select>

      <label>Tipo de Juego</label>
      <select id="reserva-tipo" onchange="generarCamposJugadores(); actualizarInterfaz();">
        <option value="" disabled selected>-- Elija --</option>
        <option value="single">Single (1 Hora)</option>
        <option value="doble">Dobles (2 Horas)</option>
      </select>

      <label>Cancha</label>
      <select id="reserva-cancha"><option value="">-- Primero seleccione hora y tipo --</option></select>
      
      <div id="jugadores-container"></div>
      <div id="precio-total" style="background:var(--accent); padding:10px; text-align:center; font-weight:900; margin-top:15px; border-radius:8px;">Total: $0</div>
      <button onclick="enviarReserva()">Confirmar Reserva</button>
    </div>
  </div>

  <div id="view-admin" class="hidden">
    <h3>Panel de Control Administrativo</h3>
    
    <div style="background: #f4f4f4; padding: 15px; border-radius: 10px; border: 1px solid #ddd; margin-bottom:20px;">
      <h4 style="margin:0 0 10px 0;">üéæ Nueva Reserva Manual</h4>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div><label>Fecha</label><input type="date" id="admin-reserva-fecha" onchange="actualizarCanchasAdmin()"></div>
        <div><label>Hora</label><select id="admin-reserva-hora" onchange="actualizarCanchasAdmin()"></select></div>
        <div><label>Duraci√≥n</label><select id="admin-reserva-duracion" onchange="actualizarCanchasAdmin()">
          <option value="1">1 Hora</option><option value="2">2 Horas</option>
        </select></div>
        <div><label>Cancha</label><select id="admin-reserva-cancha"><option value="">-- Seleccione --</option></select></div>
        <div><label>Socio / Titular</label><input type="text" id="admin-socio-nombre"></div>
        <div><label>WhatsApp (Sin +)</label><input type="number" id="admin-socio-tel" placeholder="54911..."></div>
        <div><label>Estado</label><select id="admin-reserva-estado">
          <option value="Pendiente">Pendiente</option>
          <option value="Abonada">Abonada</option>
          <option value="No se present√≥">No se present√≥</option>
        </select></div>
        <div><label>Admin responsable</label><select id="admin-usuario-creador">
          <option value="Perso 1">Fernanda</option><option value="Perso 2">Gustavo</option><option value="Perso 3">Denise</option><option value="Franquero">Franquero</option>
        </select></div>
      </div>
      <label>Jugadores / Notas</label>
      <textarea id="admin-jugadores-detalle" placeholder="Opcional..."></textarea>
      <button onclick="reservaManualAdmin()" style="margin-top:10px;">Registrar y Enviar WhatsApp</button>
    </div>

    <table id="admin-table">
      <thead>
        <tr>
          <th>Fecha/Hora</th>
          <th>Cancha</th>
          <th>Socio / Jugadores</th>
          <th>Estado</th>
          <th>Acci√≥n</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="location.reload()" style="background:#666;">Cerrar Sesi√≥n Admin</button>
  </div>

  <div id="view-success" class="hidden">
    <h2 style="color:green;">¬°Realizado!</h2>
    <div id="resumen-final" style="background:#f0f9f0; padding:15px; border-radius:8px; border:1px solid green; font-size:0.85rem;"></div>
    <button onclick="location.reload()">Volver</button>
  </div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbxaAz1Z1PKwIyiyDV_WCT1qhHC_ALdsgpqH0U0Xf1oeWFHYHISjK5unJtyCtSYISMu7/exec"; 
  let usuarioActual = {id: "", nombre: ""};

  // M√°scara Fecha Nacimiento
  document.getElementById('login-fecha').addEventListener('input', function(e) {
    let v = this.value.replace(/\D/g, '');
    if (v.length > 8) v = v.substring(0, 8);
    let final = v.length > 4 ? v.substring(0, 2) + '/' + v.substring(2, 4) + '/' + v.substring(4) :
                v.length > 2 ? v.substring(0, 2) + '/' + v.substring(2) : v;
    this.value = final;
  });

  async function llamarAPI(accion, datos = {}) {
    document.getElementById('loading').classList.remove('hidden');
    try {
      const response = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: accion, ...datos })
      });
      const res = await response.json();
      document.getElementById('loading').classList.add('hidden');
      return res;
    } catch (e) {
      document.getElementById('loading').classList.add('hidden');
      return null;
    }
  }

  async function validarUsuario() {
    const socio = document.getElementById('login-socio').value;
    const fecha = document.getElementById('login-fecha').value;
    const res = await llamarAPI('validarSocio', { socio, fecha });
    if (res?.success) {
      usuarioActual = { id: socio, nombre: res.nombre };
      
      // Fecha min (Hoy)
      const hoy = new Date().toISOString().split('T')[0];
      document.getElementById('reserva-fecha').setAttribute('min', hoy);

      document.getElementById('view-login').classList.add('hidden');
      document.getElementById('view-booking').classList.remove('hidden');
      document.getElementById('welcome-msg').innerText = "Hola, " + res.nombre;
      inicializarHoras('reserva-hora');
    } else alert("Datos incorrectos");
  }

  function inicializarHoras(idSelect) {
    const select = document.getElementById(idSelect);
    select.innerHTML = '<option value="">-- Seleccione Hora --</option>'; // Inicio Vac√≠o
    for(let i=7; i<=21; i++) {
      let opt = document.createElement('option');
      opt.value = i; opt.text = i + ":00 hs";
      select.appendChild(opt);
    }
  }

  function validarLunes(input) {
    const fechaSeleccionada = new Date(input.value + 'T00:00:00');
    if (fechaSeleccionada.getDay() === 1) {
      alert("Lunes cerrado por mantenimiento.");
      input.value = "";
      document.getElementById('config-area').classList.add('hidden');
    } else {
      document.getElementById('config-area').classList.remove('hidden');
    }
  }

  // --- NUEVA L√ìGICA DE DURACI√ìN AUTOM√ÅTICA ---
  function obtenerDuracionAutomatica() {
    const tipo = document.getElementById('reserva-tipo').value;
    if (tipo === 'doble') return 2; // Dobles = 2 horas
    if (tipo === 'single') return 1; // Single = 1 hora
    return 1; // Por defecto
  }

  async function actualizarInterfaz() {
    const f = document.getElementById('reserva-fecha').value;
    const h = document.getElementById('reserva-hora').value;
    const tipo = document.getElementById('reserva-tipo').value;
    
    // Si falta algo, no cargamos canchas
    if(!f || !h || !tipo) {
        document.getElementById('reserva-cancha').innerHTML = '<option value="">-- Complete fecha, hora y tipo --</option>';
        return;
    }

    const d = obtenerDuracionAutomatica();
    cargarCanchas(f, h, d, 'reserva-cancha');
    calcularPrecio(); // Recalcular precio tambi√©n
  }

  async function cargarCanchas(fecha, hora, duracion, idSelect) {
    const select = document.getElementById(idSelect);
    
    if(!hora) return; // Doble chequeo

    select.innerHTML = '<option value="">Verificando disponibilidad...</option>';
    const ocupadas = await llamarAPI('obtenerDisponibilidad', { fechaStr: fecha });
    
    const dia = new Date(fecha + 'T00:00:00').getDay();
    const limite = (dia === 0 || dia === 6) ? 6 : 2;
    
    let html = '<option value="">-- Seleccione Cancha --</option>';
    let count = 0;
    
    // Convertir a n√∫meros para comparar
    const hInicio = parseInt(hora);
    const hFin = hInicio + parseInt(duracion);

    for (let i = 1; i <= limite; i++) {
      let ocupada = ocupadas?.some(r => {
        if (parseInt(r.cancha) !== i) return false;
        let rInicio = parseInt(r.hora);
        let rDur = parseInt(r.duracion || 1);
        let rFin = rInicio + rDur;
        
        // Colisi√≥n de horarios: (NuevoInicio < ViejoFin) y (NuevoFin > ViejoInicio)
        return (hInicio < rFin && hFin > rInicio);
      });

      if (!ocupada) { 
        html += `<option value="${i}">Cancha ${i}</option>`; 
        count++; 
      }
    }
    
    if (count === 0) {
        alert("‚ö†Ô∏è No hay canchas disponibles para " + duracion + " hora(s) en ese horario.");
        select.innerHTML = '<option value="">‚ùå Sin lugar</option>';
    } else {
        select.innerHTML = html;
    }
  }

  function generarCamposJugadores() {
    const tipo = document.getElementById('reserva-tipo').value;
    const container = document.getElementById('jugadores-container');
    container.innerHTML = "<strong>Acompa√±antes:</strong>";
    let cant = tipo === 'single' ? 1 : 3;
    for(let i=1; i<=cant; i++) {
      container.innerHTML += `<div style="display:flex; gap:5px; margin-top:5px;">
        <select class="tipo-jugador" onchange="calcularPrecio()" style="width:35%"><option value="socio">Socio</option><option value="nosocio">Invitado</option></select>
        <input type="text" class="dato-jugador" placeholder="Nombre y DNI" style="width:65%" required>
      </div>`;
    }
    // IMPORTANTE: Al cambiar el tipo, tambi√©n se actualiza la interfaz (duraci√≥n)
    // Esto ya se llama desde el onchange del HTML, pero calcularPrecio se llama abajo
    calcularPrecio();
  }

  function calcularPrecio() {
    const h = parseInt(document.getElementById('reserva-hora').value) || 0;
    const d = obtenerDuracionAutomatica(); // Usamos la autom√°tica
    
    if(!h) return;
    
    // Precios Base por HORA (ajustar si tus precios base son por bloque completo)
    // Asumo que estos precios son POR HORA seg√∫n tu c√≥digo anterior (base * d)
    let baseSocio = h < 18 ? 2000 : 3300;
    let baseInvitado = h < 18 ? 9000 : 11000; // Invitado PAGA cancha completa precio invitado?
    
    // Ojo: En muchos clubes el socio paga su parte y el invitado la suya.
    // Tu l√≥gica original sumaba al "Socio Titular" y luego a cada "Invitado".
    // Mantenemos tu l√≥gica:
    
    let total = baseSocio * d; // Costo del titular por la duraci√≥n
    
    document.querySelectorAll('.tipo-jugador').forEach(s => {
        // Sumamos costo de cada acompa√±ante multiplicado por la duraci√≥n
        total += (s.value === 'socio' ? baseSocio : baseInvitado) * d;
    });
    
    document.getElementById('precio-total').innerText = "Total: $" + total;
    return total;
  }

  async function enviarReserva() {
    const c = document.getElementById('reserva-cancha').value;
    if(!c) return alert("Elija cancha");
    
    const inputs = document.querySelectorAll('.dato-jugador');
    for(let i of inputs) if(!i.value.trim()) return alert("Complete todos los jugadores");

    const duracionAuto = obtenerDuracionAutomatica();

    const datos = {
      fecha: document.getElementById('reserva-fecha').value,
      hora: document.getElementById('reserva-hora').value,
      duracion: duracionAuto, // Enviamos la calculada
      cancha: c,
      socioTitular: usuarioActual.id,
      detalleJugadores: Array.from(inputs).map(i => i.value).join(', '),
      total: calcularPrecio()
    };

    const res = await llamarAPI('guardarReserva', { datos });
    if(res?.success) mostrarExito(datos, res);
  }

  function mostrarExito(d, res) {
    document.getElementById('view-booking').classList.add('hidden');
    document.getElementById('view-admin').classList.add('hidden');
    document.getElementById('view-success').classList.remove('hidden');
    const txt = `Cancha ${d.cancha} | ${d.fecha} | ${d.hora}hs (${d.duracion}h). Total: $${d.total}`;
    const url = `https://wa.me/5491130351121?text=${encodeURIComponent("Reserva: "+txt)}`;
    document.getElementById('resumen-final').innerHTML = `${txt}<br><br><a href="${url}" target="_blank" style="display:block; background:#25d366; color:white; padding:10px; text-align:center; text-decoration:none; border-radius:5px;">ENVIAR WHATSAPP</a>`;
  }

  // --- ADMIN FUNCTIONS ---

  function showAdminLogin() {
    setTimeout(() => {
        let pass = prompt("üîê Ingrese la clave de administraci√≥n:");
        if (pass === null) return; 

        if (pass === "admin123") { 
            document.getElementById('view-login').classList.add('hidden');
            document.querySelector('.container').classList.add('admin-mode');
            document.getElementById('view-admin').classList.remove('hidden');
            
            // Inicializar horas admin
            const adminHora = document.getElementById('admin-reserva-hora');
            adminHora.innerHTML = "";
            for(let i=7; i<=21; i++) {
                let opt = document.createElement('option');
                opt.value = i; opt.text = i + ":00 hs";
                adminHora.appendChild(opt);
            }
            cargarAdmin();
        } else {
            alert("‚ùå Contrase√±a incorrecta");
        }
    }, 100);
  }

  async function actualizarCanchasAdmin() {
    const f = document.getElementById('admin-reserva-fecha').value;
    const h = document.getElementById('admin-reserva-hora').value;
    const d = document.getElementById('admin-reserva-duracion').value;
    if(f && h && d) cargarCanchas(f, h, d, 'admin-reserva-cancha');
  }

  async function reservaManualAdmin() {
    const f = {
      fecha: document.getElementById('admin-reserva-fecha').value,
      hora: document.getElementById('admin-reserva-hora').value,
      dur: document.getElementById('admin-reserva-duracion').value,
      can: document.getElementById('admin-reserva-cancha').value,
      nom: document.getElementById('admin-socio-nombre').value,
      tel: document.getElementById('admin-socio-tel').value,
      est: document.getElementById('admin-reserva-estado').value,
      adm: document.getElementById('admin-usuario-creador').value,
      det: document.getElementById('admin-jugadores-detalle').value
    };

    if(!f.fecha || !f.can || !f.nom) return alert("Faltan datos");

    const datos = { 
      fecha: f.fecha, hora: f.hora, duracion: f.dur, cancha: f.can, 
      socioTitular: "ADMIN-" + f.nom, detalleJugadores: f.det, 
      total: 0, estado: f.est, cobrador: f.adm 
    };

    const res = await llamarAPI('guardarReserva', { datos });
    if(res?.success) {
      if(f.tel) {
        const msj = `üéæ *Club Asturiano*\nHola ${f.nom}, reserva confirmada:\nüìÖ ${f.fecha}\n‚è∞ ${f.hora}:00hs\n‚è±Ô∏è ${f.dur}hs\nüèüÔ∏è Cancha ${f.can}\nüìå Estado: ${f.est}`;
        window.open(`https://wa.me/${f.tel}?text=${encodeURIComponent(msj)}`, '_blank');
      }
      alert("Guardado"); cargarAdmin();
    }
  }

  async function cargarAdmin() {
    const res = await llamarAPI('obtenerReservasAdmin');
    const tbody = document.querySelector('#admin-table tbody');
    tbody.innerHTML = "";
    if(!res || res.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6' style='text-align:center'>No hay reservas</td></tr>";
        return;
    }
    
    // Invertir para ver lo m√°s reciente arriba
    res.reverse().forEach((r, i) => {
      // Calculamos el √≠ndice real para enviarlo al script de Google (porque invertimos el array)
      const indexReal = res.length - 1 - i;
      
      const estado = r[9] || "Pendiente";
      const cobrador = r[10] || "-";
      let clase = "status-pendiente";
      if(estado === "Abonada") clase = "status-pagado";
      if(estado === "No se present√≥") clase = "status-noshow";

      tbody.innerHTML += `<tr>
        <td>${r[1]}<br>${r[2]}hs (${r[3]}h)</td>
        <td>Cancha ${r[4]}</td>
        <td><strong>${r[6]}</strong><br><small>${r[7]}</small></td>
        <td><span class="status-badge ${clase}">${estado}</span></td>
        <td>${estado !== "Abonada" ? 
            `<select onchange="cobrarReserva(${indexReal}, this.value)" style="font-size:0.7rem;">
                <option value="">Cobrar...</option>
                <option value="Perso 1">Fernanda</option>
                <option value="Perso 2">Gustavo</option>
                <option value="Perso 3">Denise</option>
                <option value="Franquero">Franquero</option>
             </select>` : `‚úÖ ${cobrador}`}
        </td>
      </tr>`;
    });
  }

  async function cobrarReserva(idx, admin) {
    if(!admin) return;
    if(confirm(`¬øConfirmar cobro por ${admin}?`)) {
        const res = await llamarAPI('actualizarPago', { index: idx, cobrador: admin });
        if(res?.success) cargarAdmin();
    }
  }
</script>
</body>
</html>
